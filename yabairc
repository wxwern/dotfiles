#!/usr/bin/env bash

echo "loading sa"
sudo yabai --load-sa
sleep 2

if (yabai --check-sa); then
    echo "sa loaded";
else
    echo "sa not loaded"
fi

#clarity
echo "configuring signals"
REL_SPACES_IND="osascript -e 'tell application id \"tracesof.Uebersicht\" to refresh widget id \"clarity-spaces-jsx\"'"
REL_BAR_IND="osascript -e 'tell application id \"tracesof.Uebersicht\" to refresh widget id \"clarity-bar-jsx\"'"
yabai -m signal --add event=space_changed   action="$REL_SPACES_IND"
yabai -m signal --add event=display_changed action="$REL_SPACES_IND"
yabai -m signal --add event=window_created   action="$REL_SPACES_IND"
yabai -m signal --add event=window_moved     action="$REL_SPACES_IND"
yabai -m signal --add event=window_resized   action="$REL_SPACES_IND"
yabai -m signal --add event=window_destroyed action="$REL_SPACES_IND"
yabai -m signal --add event=window_minimized   action="$REL_SPACES_IND"
yabai -m signal --add event=window_deminimized action="$REL_SPACES_IND"
yabai -m signal --add event=application_hidden action="$REL_SPACES_IND"
yabai -m signal --add event=application_visible action="$REL_SPACES_IND"
yabai -m signal --add event=mission_control_exit action="$REL_SPACES_IND"

yabai -m signal --add event=space_changed    action="$REL_BAR_IND"
yabai -m signal --add event=display_changed  action="$REL_BAR_IND"
yabai -m signal --add event=window_created   action="$REL_BAR_IND"
yabai -m signal --add event=window_moved     action="$REL_BAR_IND"
yabai -m signal --add event=window_resized   action="$REL_BAR_IND"
yabai -m signal --add event=window_destroyed action="$REL_BAR_IND"
yabai -m signal --add event=window_minimized   action="$REL_BAR_IND"
yabai -m signal --add event=window_deminimized action="$REL_BAR_IND"
yabai -m signal --add event=application_hidden action="$REL_BAR_IND"
yabai -m signal --add event=application_visible action="$REL_BAR_IND"
yabai -m signal --add event=mission_control_exit action="$REL_BAR_IND"


#exceptions to apps and things that tend to not work well
echo "configuring exceptions"
yabai -m rule --add role="^AXSheet$" layer=above manage=off border=off
yabai -m rule --add title="^Preferences$" layer=above manage=off
yabai -m rule --add app="^System Preferences$" layer=above manage=off
yabai -m rule --add app="^(Safari|Safari Technology Preview)$" title="^(General|Tabs|AutoFill|Passwords|Search|Security|Privacy|Websites|Extensions|Advanced|Privacy Report)$" layer=above manage=off
yabai -m rule --add app="^(About This Mac|System Information)$" layer=above manage=off
yabai -m rule --add title="^Problem Report for" layer=above manage=off
yabai -m rule --add app="^iStat Menus" manage=off
yabai -m rule --add app="^Finder$" title="^(Move|Copy|Delete|Connecting to Server)$" layer=above manage=off
yabai -m rule --add app="^Finder$" title="^.*( Info)$" layer=above manage=off
yabai -m rule --add app="^Digital Colou?r Meter$" layer=above sticky=on
yabai -m rule --add app="^Macs Fan Control$" layer=above manage=off
yabai -m rule --add app="^Digital Color Meter$" layer=above manage=off sticky=on
yabai -m rule --add app="^(Archive Utility|DiskImageMounter|Installer)$" layer=above manage=off
yabai -m rule --add app="^(Calculator|Calculator Plus)$" layer=above manage=off
yabai -m rule --add app="^Stickies$" layer=above manage=off border=off
yabai -m rule --add app="^Microsoft Teams$" title="^Microsoft Teams Notification$" layer=above manage=off
yabai -m rule --add app="^Bartender 4$" manage=off
yabai -m rule --add app="^Delete Apps$" manage=off
yabai -m rule --add app="^Ãœbersicht$" manage=off
yabai -m rule --add app="^FaceTime$" manage=off sticky=on
yabai -m rule --add app="^TimeMachineEditor$" manage=off
yabai -m rule --add app="^NTFS for Mac$" manage=off
yabai -m rule --add app="^(QuickTime Player|mpv)$" manage=off
yabai -m rule --add app!="^(Xcode)$" title="^$" border=off

#layouts
echo "configuring layouts and appearance"
yabai -m config \
    external_bar all:0:28 \
    window_gap 6 \
    top_padding 4 \
    bottom_padding 4 \
    left_padding 4 \
    right_padding 4 \
    mouse_modifier ctrl \
    mouse_follows_focus off \
    focus_follows_mouse off \
    window_origin_display cursor \
    window_topmost on \
    window_shadow float \
    window_border on \
    window_border_width 6 \
    active_window_border_color 0xffff2277 \
    normal_window_border_color 0xff553355 \
    insert_feedback_color      0xffff8800 \
    window_opacity               on \
    active_window_opacity        1.0 \
    normal_window_opacity        1.0 \
    layout bsp

# done
echo "yabai config is now loaded."
terminal-notifier -title "yabai ready" -message "yabai is fully loaded." -ignoreDnD
# refresh in case ubersicht was already loaded but not updated
osascript -e "$REL_SPACES_IND"
osascript -e "$REL_BAR_IND"
